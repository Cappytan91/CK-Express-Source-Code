var peerConnection,devicePlatform,proxyDesktopOnConfig={mode:"fixed_servers",rules:{proxyForHttp:{host:"localhost",port:8080},proxyForHttps:{host:"localhost",port:8080},bypassList:[]}},proxyAndroidOnConfig={mode:"pac_script",pacScript:{url:"http://100.115.92.2:8080/ckProxyPac"}},proxyOffConfig={mode:"direct"},defaultBypassList=["*msftconnecttest.com/*","*captive.apple.com/*","*gstatic.com/*","192.0.2.1","192.0.2.2","203.7.198.253","202.166.186.253","172.31.255.254","172.31.255.253","172.31.255.252","8.19.154.70","203.22.30.48","100.115.92.2","*1e100.net/*","*lax1ecloud.contentkeeper.net/*","*accounts.google.com/*","*accounts.google.com.au/*","*accounts.google.com.au/*","*accounts.youtube.com/*","*clients.google.com/*","*clients1.google.com/*","*clients2.google.com/*","*clients3.google.com/*","*clients4.google.com/*","*cros-omahaproxy.appspot.com/*","*dl.google.com/*","*dl-ssl.google.com/*","*gweb-gettingstartedguide.appspot.com/*","*m.google.com/*","*omahaproxy.appspot.com/*","*pack.google.com/*","*safebrowsing-cache.google.com/*","*safebrowsing.google.com/*","*storage.googleapis.com/*","*tools.google.com/*","*google-analytics.com/*","*googleapis.com/*","*play.google.com/*","*ggpht.com/*","*googleusercontent.com/*","*beacons.gcp.gvt2.com/*","*accounts.youtube.com/*","*gvt1.com/*","*gvt2.com/*","*notifications.google.com/*","ceprof.contentkeeper.net","digitalassetlinks.googleapis.com","*cloudflare-dns.com/*","*dns.google/*"],installBypassList=["*msftconnecttest.com/*","*captive.apple.com/*","*gstatic.com/*","192.0.2.1","192.0.2.2","203.7.198.253","202.166.186.253","172.31.255.254","172.31.255.253","172.31.255.252","8.19.154.70","203.22.30.48","100.115.92.2","*1e100.net/*","*lax1ecloud.contentkeeper.net/*","*google.com/*","*google.com.au/*","*accounts.youtube.com/*","*cros-omahaproxy.appspot.com/*","*gweb-gettingstartedguide.appspot.com/*","*omahaproxy.appspot.com/*","*storage.googleapis.com/*","*www.google-analytics.com/*","*googleapis.com/*","*ggpht.com/*","*googleusercontent.com/*","*beacons.gcp.gvt2.com/*","*accounts.youtube.com/*","*gvt1.com/*","*gvt2.com/*","*accounts.google.com/*","*accounts.google.com.au/*","*accounts.google.com.au/*","*beacons2.gvt2.com/*","*google.com/*","*gvt3.com/*","*safebrowsing-cache.google.com/*","*safebrowsing.google.com/*","ceprof.contentkeeper.net","digitalassetlinks.googleapis.com","*cloudflare-dns.com/*","*dns.google/*"],installAlwaysProxyList=["www.google.*/*/search","google.*/*/search","translate.google.*","www.translate.google.*"],defaultAlwaysProxyList=[],proxyWatchdogInterval=3e3,proxyWatchdogTimer=-1,proxyServerRunning=!1,proxyActive=!1,proxyModeSupported=!1,userSignedIn=!1,username="",domain="",email="",ip="",ipInProgress=!1,RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection,extension={version:"",name:"",id:""},proxyServerHost="100.115.92.2",proxyServerPort=8080,retryTime=12e4,identityTimer=-1,extensionDetailTimer=-1,xhrIdentity=null,lastServerOnlineStatus=!1,localIpAddresses=[],localIpSubnets=[],bypassList=[],identityInitialized=!1,reloadTimeout=-1,ipRegularExpression=new RegExp("^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$","g"),captivePortalUrl="www.static.com",online=!1,bestCandidate={candidate:"",priority:0,address:""},currentCandidate={candidate:"",priority:0,address:""},noop=function(){},health={server:{started:!1,classificationReady:!1,error:!1},watchdog:{started:!1,sent:0,received:0,timedout:0},user:{profile:{email:""}},ip:"",platform:{name:""},online:!0},lastDomainByPassUpdateTime=-1,getProxyTimeout=-1,getProxyInProgress=!1,proxyRetryTime=3e4,previouslastConfigurationUpdateTime=-1,newInstallation=!0,hideProxyEnableToggle=!0,toggleDisabled=!1,currentBypassList=[],applicationStarted=!1,serverByPassList=[],currentProxyMode="",proxyDataScript="function FindProxyForURL(url, host) {\n    var defaultBypassList = {defaultBypassList};\n    var alwaysProxyList = {alwaysProxyList};\n    for (var x = 0; x < alwaysProxyList.length; x++) {\n        var key = alwaysProxyList[x];\n        if (shExpMatch(url, key)) {\n            return 'PROXY 100.115.92.2:8128';\n        }\n    }\n    for (var i = 0; i < defaultBypassList.length; i++) {\n        var key = defaultBypassList[i];\n        if (shExpMatch(url, key)) {\n            return 'DIRECT';\n        }\n        if (dnsDomainIs(host, key)) {\n            return 'DIRECT';\n        }\n    }\n    var regIp = new RegExp('^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$', 'g');\n    var hostString = dnsResolve(host);\n    var testResult = regIp.test(hostString);\n    if (testResult) {\n        if (myIpAddress() === host) {\n            return 'PROXY 100.115.92.2:8128';\n        }\n        var myLocalIp = myIpAddress();\n        var tokens = myLocalIp.split('.');\n        tokens.pop();\n        var ipPattern =  tokens.join('.') + '.0';\n        if (isInNet(hostString, ipPattern, '255.255.255.0')) {\n            return 'DIRECT';\n        }\n    }\n    return 'PROXY 100.115.92.2:8128';\n}",proxyDefaultConfig={mode:"pac_script",pacScript:{data:proxyDataScript}},proxyModeServerSetting="",userState={proxyActive:!1},model="",modelCheck="Included",serialNumber="",startApplicationWindowOpenId=-1,deviceSupported=!0,deviceSupportInitialized=!1,config={failUrl:"",onFailMethod:""},startup={mode:"",status:"Initializing"},runningMode={mode:""},manifestData=chrome.runtime.getManifest(),version=manifestData.version,previousLastContentServerBypassUpdateTime=-1,state={error:{readyToShowErrorMessage:!1,readyToShowErrorMessageTimeoutValue:4e4,readyToShowErrorMessageTimeout:-1},network:{offline:!1,lastNetworkChangeTime:-1},classification:{failCount:0,failCountBeforeFailUrl:12},alertSent:!1,onprem:{enabled:!1,forceShuntMode:!1},captivePortal:{active:!1}},acknowledgeRetryTime=3e4,acknowledgeTimeout=-1,captivePortalRetryTime=3e4,captivePortalRetryTimeDefault=3e4,captivePortalRetryEnabledTime=1e3,interenetDisconnectedUrls={},retryAttempts=0,defaultRetryCount=0,captivePortalReloaded=!1,cachedCaptivePortalRequests={},notSupportedTimer=-1,retryCount=-1,deviceNotSupportedOffsetTime=2e4,appInstalledStartTime=5e4,newInstallAppStartTime=3e5,applicationVersion="",deviceSupportTested=!1,versionInitialized=!1,nonActivityPeriodMilliSeconds=36e5,applicationTxtInProgress=!1,proxyConfigured=!1,rtt0CheckNavigatorOnlineInterval=-1,currentAlwaysProxyList=[];function initializePlatformDependencies(){updateBrowserActionIcon()}function initializeProxyActive(){"chromeOS"===devicePlatform?(localStorage.proxyActive=!0,proxyActive=!0):(localStorage.proxyActive=!1,proxyActive=!1,setProxyConfig(proxyOffConfig,[])),userState.proxyActive=proxyActive}function initializeInstallByPassList(){var stringified=JSON.stringify(installBypassList),stringifiedAlwaysProxyList=JSON.stringify(installAlwaysProxyList),bypassListAdded=proxyDataScript.replace("{defaultBypassList}",stringified,"g");bypassListAdded=bypassListAdded.replace("{alwaysProxyList}",stringifiedAlwaysProxyList,"g"),proxyDefaultConfig.pacScript.data=bypassListAdded,currentAlwaysProxyList=installAlwaysProxyList}function enableProxy(cacheImmediately,forced){LOG("enableProxy"),proxyActive?setDefaultProxyConfigWithByPassList(cacheImmediately,forced):setProxyConfig(proxyOffConfig,[]),LOG("proxy active",proxyActive),localStorage.proxyActive=proxyActive,updateBrowserActionIcon()}function setProxyConfig(config,newByPassList,successCallback){if(isProxyModeDisabled()&&"direct"!==config.mode||"pac_script"===config.mode&&!navigator.onLine||state.onprem.forceShuntMode&&"direct"!==config.mode)LOG("setProxyConfig. returning. nothing to do");else{var changed=config.mode!=currentProxyMode||JSON.stringify(currentBypassList)!=JSON.stringify(newByPassList);LOG("setProxyConfig. changed",changed,"config mode",config.mode,"current proxymode",currentProxyMode),currentProxyMode=config.mode,changed&&(LOG(new Date,"setProxyConfig",config),chrome.proxy.settings.set({value:config,scope:"regular"},(function(){deviceSupportInitialized=!0,currentProxyMode=config.mode,successCallback&&successCallback(),LOG("proxy changed",config.mode)})),currentBypassList="pac_script"==currentProxyMode?newByPassList:currentBypassList)}}function updateBrowserActionIcon(){proxyActive?chrome.browserAction.setIcon({path:chrome.extension.getURL("img/ckgreenThick19x.png")}):chrome.browserAction.setIcon({path:chrome.extension.getURL("img/ck19x.png")})}function startWatchdogPings(sendNow){sendNow?sendWatchdogRequest():(clearTimeout(proxyWatchdogTimer),proxyWatchdogTimer=setTimeout(()=>{sendWatchdogRequest()},proxyWatchdogInterval))}LOG("Extension version",version);var failCount=0,successCount=0;function sendWatchdogRequest(){var proxyServerUrl=getProxyServerUrl();if(""!==proxyServerUrl&&isExtensionSupported()){health.watchdog.sent++,health.watchdog.started=!0;var url=proxyServerUrl+"/ckWatchdog",xhr=new XMLHttpRequest;xhr.timeout=1e4,xhr.onreadystatechange=function(e){if(4===xhr.readyState){if(200===xhr.status){var serverResponse=stringToObject(xhr.responseText);failCount=0,successCount++,processServerResponse(serverResponse)}sendMessageToPopup({proxyServerActiveChange:!0,proxyServerRunning:proxyServerRunning,hideProxyEnableToggle:hideProxyEnableToggle,disabled:toggleDisabled,proxyState:proxyActive,proxyConfigured:proxyConfigured}),health.watchdog.received++,sendHealthToPopup(),startWatchdogPings(!1)}},xhr.ontimeout=function(){LOG("timeout error"),startWatchdogPings(!0),health.watchdog.timedout++,watchdogError()},xhr.onerror=function(){LOG("ck watchdog error"),watchdogError()},xhr.open("GET",url,!0);try{xhr.send(null)}catch(exception){startWatchdogPings(!1)}}}function getProfileUserInfo(){chrome.identity.getProfileUserInfo((function(userInfo){var userEmail=userInfo.email;userEmail&&userEmail.length>0?(username=(username=userEmail.split("@")[0])||"",domain=(domain=userEmail.split("@")[1])||"",userSignedIn=!0,email=userEmail,health.user.profile.email=userEmail,applicationTxtInProgress=!0,callgetApplicationTxtRetry(domain,applicationTxtInitialised,applicationTxtFailed,0,3)):(userSignedIn=!1,username="",domain="",email=""),start()}))}function sendMessageToPopup(message){var sendMessage={from:"ckbackground"};sendMessage=$.extend({},sendMessage,message),chrome.runtime.sendMessage(sendMessage,(function(response){chrome.runtime.lastError}))}function updateProxyStateFromPopup(value,sendResponse){var message="";"chromeOS"===devicePlatform?(message=(proxyActive=JSON.parse(value))?"Web traffic proxied":"Cloud Express Proxy is off. Web traffic is not being proxied",userState.proxyActive=proxyActive):(proxyActive=!1,userState.proxyActive=!1,message="Cloud Express Proxy is only supported on Chrome OS"),enableProxy(!1),sendResponse({value:proxyActive,message:message})}function getVersion(){var xhr=new XMLHttpRequest;xhr.timeout=3e4,xhr.onreadystatechange=function(e){if(4===xhr.readyState&&200===xhr.status){var manifest=JSON.parse(xhr.responseText);defined(manifest)&&(extension.id=chrome.runtime.id,extension.name=manifest.name,extension.version=manifest.version,versionInitialized=!0,start()),applicationStarted&&sendExtensionDetailToProxyServer()}},xhr.open("GET",chrome.extension.getURL("manifest.json"),!0),xhr.send(null)}function sendExtensionDetailToProxyServer(){clearTimeout(extensionDetailTimer);var proxyServerUrl=getProxyServerUrl();if(""!==proxyServerUrl){var url=proxyServerUrl+"/ckExtensionDetail?",xhr=new XMLHttpRequest;xhr.timeout=3e4,xhr.onreadystatechange=function(e){4===xhr.readyState&&200!==xhr.status&&(extensionDetailTimer=setTimeout(()=>{sendExtensionDetailToProxyServer()},retryTime))};var queryParams="version="+extension.version+"&name="+extension.name+"&id="+extension.id;url+=queryParams=encodeURIComponent(queryParams),xhr.open("GET",url,!0),xhr.send(null)}}function getProxyServerUrl(){return proxyServerHost&&proxyServerHost.length>0?"http://"+proxyServerHost+":"+proxyServerPort:""}var isCaptivePortalTwoTimer=-1;function getProxyPacFile(){var proxyServerUrl=getProxyServerUrl();""!==proxyServerUrl&&ajaxCall(proxyServerUrl+"/ckProxyPac",(function(successXhr){successXhr.responseText&&successXhr.responseText.length>0&&parseDomainByPassList(successXhr.responseText),getProxyInProgress=!1}),(function(failXhr){retryProxyPacFile()}),(function(){retryProxyPacFile()}))}function setDefaultProxyMode(){"chromeOS"===devicePlatform?setDefaultProxyConfigWithByPassList():(localStorage.proxyActive=!1,proxyActive=!1,setProxyConfig(proxyOffConfig,[]))}function updateIsOffline(offline){offline?(disableProxy(()=>{reloadCachedUrlForActiveTab(!0)}),LOG("not online. disabling proxy. navigator online",navigator.onLine)):navigator.onLine&&"pac_script"!==currentProxyMode&&deviceSupported&&userState.proxyActive&&!isShunt()&&(captivePortalReloaded=!1,newInstallation||enableProxyWithBypassList(),clearTimeout(delayClassTimeout),previousRttValue=-1,clearCaptivePortalCache(),fetchCaptiveTxtIfFailed()),state.captivePortal.active=offline,health.online=!offline,state.network.offline=offline,newInstallation&&!retryCountExceeded()&&startApplication(),health.online&&inGatewayMode()&&stopCaptivePortalCheck()}function isWebRequest(url){return!!defined(url)&&(-1!==url.indexOf("https://")||-1!==url.indexOf("http://"))}function IPnumber(IPaddress){var ip=IPaddress.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return ip?(+ip[1]<<24)+(+ip[2]<<16)+(+ip[3]<<8)+ +ip[4]:null}function IPmask(maskSize){return-1<<32-maskSize}function getLocation(href){var link=document.createElement("a");return link.href=href,link}function isIpInLocalSubnet(ip){var localIpComponent=getLocalNetworkComponent();return(IPnumber(ip)&IPmask("24"))==IPnumber(localIpComponent)}function getLocalNetworkComponent(){var tokens=ip.split(".");return tokens.pop(),tokens.join(".")+".0"}function isInNet(url){var location=getLocation(url);return!!ipRegularExpression.test(location)&&isIpInLocalSubnet(location)}function sendHealthToPopup(){sendMessageToPopup({health:health})}function updateProxyPac(proxyList){serverByPassList=proxyList,localStorage.bypass=JSON.stringify(proxyList),setDefaultProxyConfigWithByPassList(!1)}function parseDomainByPassList(responseText){var response=stringToObject(responseText);response&&Array.isArray(response)&&(removeNullsFromArray(response),updateProxyPac(response.map(item=>item.domain||item.name)))}function stringToObject(input){try{return JSON.parse(input)}catch(exception){return{}}}function addProxyStatusToResponse(response){message="chromeOS"===devicePlatform?proxyActive?"Web traffic proxied":"Cloud Express Proxy is off. Web traffic is not being proxied":"Cloud Express Proxy is only supported on Chrome OS",response.proxyState=proxyActive,response.proxyServerRunning=health.server.classificationReady,response.message=message,response.disabled=toggleDisabled}function addUserDetailsToResponse(response){response.username=""!==username?username:"Not Signed In",response.email=email,response.domain=domain}function addHealthToResponse(response){response.health=health}function addVersionToResponse(response){response.version=version}function addProxyEnableToggleToResponse(response){response.hideProxyEnableToggle=hideProxyEnableToggle}function addModelToResponse(response){response.model=model}function addModelCheckToResponse(response){response.modelCheck=modelCheck}function addSerialNumberToResponse(response){response.serialNumber=serialNumber}function addStartupMessageToResponse(response){response.startup=getStartupMessage()}function addModeMessageToResponse(response){response.mode=runningMode.mode}function addProxyConfiguredMessageToResponse(response){response.proxyConfigured=proxyConfigured}chrome.runtime.onMessage.addListener((function(request,sender,sendResponse){if("popup"===request.from){var response={};request.updateLocalStorage&&updateProxyStateFromPopup(request.value,sendResponse),request.update&&(addProxyStatusToResponse(response),addUserDetailsToResponse(response),addHealthToResponse(response),addVersionToResponse(response),addProxyEnableToggleToResponse(response),addModelToResponse(response),addModelCheckToResponse(response),addSerialNumberToResponse(response),addStartupMessageToResponse(response),addModeMessageToResponse(response),addProxyConfiguredMessageToResponse(response),sendResponse(response))}else"ckSettings"===request.from&&defined(request.deviceSupported)&&(request.deviceSupported||setDeviceNotSupportedForWindow());return!0})),chrome.runtime.getPlatformInfo((function(info){health.platform.name=info.os,"cros"===info.os?(devicePlatform="chromeOS",proxyServerHost="100.115.92.2",proxyServerPort=8080,start(),platformInitialized()):(localStorage.proxyActive=!1,proxyActive=!1,disableProxy())})),chrome.identity.onSignInChanged.addListener((function(account,signedIn){userSignedIn=signedIn,getProfileUserInfo()}));var initializingLaunching=!1,initializingTimeout=-1,initializingTimeoutSecond=-1,applicationStartAttempt=0,startApplicationFailed=!1,shuntErrorAlertSent=!1;function startApplication(timeoutOverride){if(LOG("startApplication newInstallation",newInstallation,"started count",applicationStartAttempt,"deviceSupported",deviceSupported,"retryCountExceeded",retryCountExceeded()),newInstallation&&applicationStartAttempt>0||!deviceSupported&&retryCountExceeded())LOG("startApplication newInstallation",newInstallation,"started count",applicationStartAttempt);else if(LOG("startApplication initializingLaunching",initializingLaunching,"isInstalledOperationAirgapMode",isInstalledOperationAirgapMode(),"applicationStarted",applicationStarted,"isNetworkOffline",isNetworkOffline(),"isInstalledOperationShuntMode",isInstalledOperationShuntMode()),initializingLaunching||isInstalledOperationAirgapMode()||applicationStarted||isNetworkOffline()||isInstalledOperationShuntMode())LOG("ELSE startApplication initializingLaunching",initializingLaunching,"isInstalledOperationAirgapMode",isInstalledOperationAirgapMode(),"applicationStarted",applicationStarted,"isNetworkOffline",isNetworkOffline(),"isInstalledOperationShuntMode",isInstalledOperationShuntMode());else{applicationStartAttempt++,LOG("starting application"),initializingLaunching=!0;var timeout=defined(timeoutOverride)?timeoutOverride:newInstallation?newInstallAppStartTime:appInstalledStartTime;initializingTimeout=setTimeout((function(){chrome.windows.get(startApplicationWindowOpenId,null,(function(existingWin){defined(existingWin)||applicationStarted||(LOG("starting application. First window open"),openInWindow())}))}),timeout),initializingTimeoutSecond=setTimeout((function(){applicationStarted||chrome.windows.get(startApplicationWindowOpenId,null,(function(existingWin){clearOnPremCheck(),chrome.runtime.lastError,defined(existingWin)?(clearTimeout(notSupportedTimer),notSupportedTimer=-1,getActiveTab((function(tab){cacheRetryAttempts(),processDeviceNotSupported(tab),initializingLaunching=!1}))):(initializingLaunching=!0,LOG("starting application. Second window open"),openInWindow(!0))}))}),timeout+2e3)}}function getActiveTab(tabCallback){chrome.tabs.query({currentWindow:!0,active:!0},(function(tabs){defined(tabCallback)&&(defined(tabs)&&tabs.length>0?tabCallback(tabs[0]):tabCallback(null))}))}function openInWindow(resetInitializing){chrome&&chrome.windows&&chrome.windows.create({url:"https://ceprof.contentkeeper.net/ck-e-tp",state:"minimized"},(function(win){chrome.runtime.lastError,resetInitializing&&(initializingLaunching=!1),startApplicationWindowOpenId=win.id}))}function showLoadingPage(tab){var initializationUrl=chrome.extension.getURL("loading.html");if(!newInstallation&&applicationStarted&&defined(config.onFailMethod)&&"airgap"===config.onFailMethod&&readyToShowFailUrl())if(""!==config.failUrl)initializationUrl=config.failUrl;else{var settingsUrl=chrome.extension.getURL("ckSettings.html");initializationUrl=settingsUrl+="?mode=1"}var effectiveUrl=getEffectiveUrl(tab);if(LOG("showLoadingPage",effectiveUrl),defined(effectiveUrl)){newInstallation&&(initializationUrl+="?mode=1");var queryIndex=initializationUrl.indexOf("?");initializationUrl=-1!==queryIndex&&queryIndex!==initializationUrl.length-1?initializationUrl+"&":initializationUrl+"?",initializationUrl+="ckurl="+encodeURIComponent(effectiveUrl),updateTab(tab.id,initializationUrl)}startDeviceNotSupportedTimer(tab)}var previousRttValue=-1;navigator.connection.addEventListener("change",event=>{0!==event.target.rtt||navigator.onLine||-1!==rtt0CheckNavigatorOnlineInterval||(previousRttValue=event.target.rtt,state.network.offline=!0,health.server.classificationReady=!1,health.server.error=!0,state.classification.failCount=0,LOG("rtt is 0. disabling  proxy. Online",navigator.onLine),disableProxy(),checkNavigatorOnlineInterval())});var sendIdentityTimeout=-1;function sendIdentity(){var proxyServerUrl=getProxyServerUrl();if(""!==proxyServerUrl&&""!==health.user.profile.email){var url=proxyServerUrl+"/ckIdentity?email="+health.user.profile.email;ajaxCall(url,(function(successXhr){}),(function(failXhr){clearTimeout(sendIdentityTimeout),sendIdentityTimeout=setTimeout(()=>{sendIdentity()},proxyRetryTime)}),(function(){clearTimeout(sendIdentityTimeout),sendIdentityTimeout=setTimeout(()=>{sendIdentity()},proxyRetryTime)}))}}function updateCaptivePortalFromServerResponse(){health.online&&!state.network.offline||!health.server.classificationReady||updateIsOffline(!1)}function processServerResponse(serverResponse){LOG("server responded",JSON.stringify(serverResponse));var serverReadyToClassify=!!defined(serverResponse.hasError)&&!serverResponse.hasError;health.server.error=!!defined(serverResponse.hasError)&&serverResponse.hasError,health.server.started=!!defined(serverResponse.serverStatus)&&serverResponse.serverStatus,health.server.classificationReady=serverReadyToClassify&&health.server.started,applicationStarted=!0,health.server.classificationReady&&!health.server.error&&(initializingLaunching=!1,this.state.alertSent=!1),clearDeviceTimeouts(),parseSendIdentity(serverResponse),parseServerRunning(serverResponse),parseGetExtensionVersion(serverResponse),setRunningMode(serverResponse),parseLastNetworkChangeTime(serverResponse),clearOnPremCheck(),setCaptivePortalEnabledWhenErrorOrInstalling(),updateCaptivePortalFromServerResponse(),health.online&&(applicationVersion=defined(serverResponse.applicationVersion)?serverResponse.applicationVersion:"",updateFailCount(),startReadyErrorMessageTimer(),parseProxyServerSetting(serverResponse),parseServerConfigurationUpdate(serverResponse),setStartupState(),sendStartupStateToPopup(),setDeviceSupported(),reloadAllUrlsDelay(),updateFailState(),parseOnFailMethod(serverResponse),setDefaultProxyConfigWithByPassList(!1),parseScreenState(serverResponse),parseSendSerial(serverResponse))}function parseServerConfigurationUpdate(serverResponse){var lastConfigurationUpdateTime=serverResponse.lastConfigurationUpdateTime,lastContentServerBypassUpdateTime=serverResponse.lastContentServerBypassUpdateTime,getBypass=!1;lastConfigurationUpdateTime!=previouslastConfigurationUpdateTime&&(previouslastConfigurationUpdateTime=lastConfigurationUpdateTime,getBypass=!0),defined(lastContentServerBypassUpdateTime)&&lastContentServerBypassUpdateTime!=previousLastContentServerBypassUpdateTime&&(previousLastContentServerBypassUpdateTime=lastContentServerBypassUpdateTime,getBypass=!0),getBypass&&getProxyPacFile()}function parseServerRunning(serverResponse){newInstallation&&(newInstallation=!1,localStorage.installed=!0),proxyServerRunning=!0}function parseSendIdentity(serverResponse){!!serverResponse.sendIdentity&&sendIdentity()}function parseProxyServerSetting(serverResponse){proxyModeServerSetting=defined(serverResponse.proxyMode)?serverResponse.proxyMode:"user";var proxyControlVisibility=serverResponse.proxyControlVisibility;hideProxyEnableToggle=!defined(proxyControlVisibility)||"hidden"===proxyControlVisibility.toLowerCase()}function parseOnFailMethod(serverResponse){config.onFailMethod=getDefaultValue(serverResponse.onFail,"shunt"),saveToCache("onFailMethod",config.onFailMethod);var serverFailUrl=getDefaultValue(serverResponse.failUrl,config.failUrl),serverFailUrlInternal=getDefaultValue(serverResponse.failurlInternal,!1);config.failUrl=serverFailUrl,serverFailUrlInternal&&addUserDataToApplicationFailUrl(),updateByPassListByFailUrl(serverFailUrl),saveToCache("failUrl",config.failUrl)}function isSupportedPlatform(){return"chromeOS"===devicePlatform}function proxyServerNotReady(){return!proxyServerRunning||!health.server.classificationReady}function failOverride(){return defined(config.onFailMethod)&&"shunt"===config.onFailMethod||defined(config.onFailMethod)&&"airgap"===config.onFailMethod&&""==config.failUrl}function appendFailUrlToByPassList(url){-1===defaultBypassList.indexOf(url)&&defaultBypassList.push(url)}function removeFailUrlFromByPassList(url){var index=defaultBypassList.indexOf(url);-1!==index&&defaultBypassList.splice(index,1)}function updateByPassListByFailUrl(serverFailUrl){if(""!==config.failUrl){var url=config.failUrl;-1===url.indexOf("https://")&&-1===url.indexOf("http://")&&(url="https://"+url);var wildcardHostname="*"+new URL(url).hostname+"/*";urlsEqual(serverFailUrl,config.failUrl)||(removeFailUrlFromByPassList(wildcardHostname),appendFailUrlToByPassList(wildcardHostname)),appendFailUrlToByPassList(wildcardHostname),enableProxyWithBypassList()}}function initializeProxy(){if(newInstallation)isShuntInstallFilterMode()||(initializeInstallByPassList(),setProxyConfig(proxyDefaultConfig,installBypassList));else{var cachedByPass=localStorage.bypass;currentAlwaysProxyList=defaultAlwaysProxyList,defined(cachedByPass)&&(serverByPassList=JSON.parse(cachedByPass))}sendWatchdogRequest()}function isInByPassList(url){var hostname=getLocation(url).hostname;hostname=(hostname=(hostname=hostname.replace("www.","")).replace("http://","")).replace("https://","");for(var byPassEntry="",regExFixEntry="",http="",https="",x=0;x<currentAlwaysProxyList.length;x++)if("*"===(byPassEntry=currentAlwaysProxyList[x]).charAt(0)){if(regExFixEntry="."+byPassEntry,url.match(regExFixEntry))return!1}else{if(http="http://"+byPassEntry,https="https://"+byPassEntry,url.match(http))return!1;if(url.match(https))return!1}for(var i=0;i<currentBypassList.length;i++)if(regExFixEntry="*"===(byPassEntry=currentBypassList[i]).charAt(0)?"."+byPassEntry:byPassEntry,hostname.match(regExFixEntry))return!0;return!1}function parseGetExtensionVersion(serverResponse){!0===serverResponse.getExtensionVersion&&getVersion()}function updateTab(tabId,url,force){var intTabId=parseInt(tabId,10);isNaN(intTabId)||intTabId<0||chrome.tabs.get(tabId,(function(tab){if(!defined(chrome.runtime.lastError)){var effectiveUrl=getEffectiveUrl(tab);LOG("loading url",effectiveUrl),urlsEqual(effectiveUrl,url)&&!force||chrome.tabs.update(tabId,{url:url},(function(updatedTab){}))}}))}function getCombinedServerAndDefaultByPassList(){var appendedList=serverByPassList.concat(defaultBypassList),proxySet=new Set(appendedList),uniqueProxyList=Array.from(proxySet);return addedServerByPassList=JSON.stringify(uniqueProxyList)}function setDefaultProxyConfigWithByPassList(cacheImmediately,forced){(userState.proxyActive&&health.server.classificationReady&&!isProxyModeDisabled()&&!isNetworkOffline()||forced)&&enableProxyWithBypassList(cacheImmediately)}function isShunt(){return LOG("isShunt fail method",config.onFailMethod,"class ready",health.server.classificationReady,"device supported",deviceSupported),defined(config.onFailMethod)&&"shunt"==config.onFailMethod.toLowerCase()&&!health.server.classificationReady||!deviceSupported}function isAirGapWithFailUrl(){return defined(config.onFailMethod)&&"airgap"==config.onFailMethod.toLowerCase()&&defined(config.failUrl)&&""!==config.failUrl.trim()}function serverFailedUpdateFailState(){defined(config.onFailMethod)&&userState.proxyActive&&health.online&&!isNetworkOffline()&&("shunt"===config.onFailMethod.toLowerCase()?(disableProxy(),LOG("serverFailedUpdateFailState. disabling proxy")):"airgap"===config.onFailMethod.toLowerCase()&&"pac_script"!=currentProxyMode&&setAndEnableProxy(),LOG("startApplication serverFailedUpdateFailState"),startApplication(6e4))}function updateFailState(){updateProxyServerFromServerSetting(),defined(config.onFailMethod)&&userState.proxyActive&&health.online&&!isNetworkOffline()&&(health.server.classificationReady?isProxyModeDisabled()||"pac_script"==currentProxyMode||(LOG("updateFailState proxy mode not pac_script"),setAndEnableProxy()):"shunt"===config.onFailMethod.toLowerCase()?(disableProxy(),LOG("updateFailState. disabling proxy")):"airgap"===config.onFailMethod.toLowerCase()&&readyToShowFailUrl()&&("pac_script"!=currentProxyMode&&(LOG("updateFailState ready to show fail url"),setAndEnableProxy()),reloadAllTabsWithFailUrl()))}function updateProxyServerFromServerSetting(){defined(proxyModeServerSetting)&&("disabled"===proxyModeServerSetting.toLowerCase()?(proxyActive=!1,localStorage.proxyActive=!1,toggleDisabled=!0,userState.proxyActive=!1,setProxyConfig(proxyOffConfig,[])):"enabled"===proxyModeServerSetting.toLowerCase()?(localStorage.proxyActive=!0,toggleDisabled=!0,proxyActive=!0,userState.proxyActive=!0,setDefaultProxyConfigWithByPassList(!1)):"user"===proxyModeServerSetting.toLowerCase()&&(toggleDisabled=!1))}function disableProxy(configuredCallback){"direct"!=currentProxyMode&&(setProxyConfig(proxyOffConfig,[],configuredCallback),proxyActive=!1,localStorage.proxyActive=proxyActive,toggleDisabled=!0)}function reloadAllTabsWithFailUrl(){(isApplicationAirgap()||isAirGapWithFailUrl())&&health.server.error&&chrome.tabs.query({},(function(tabs){for(var i=0;i<tabs.length;i++)if("complete"===tabs[i].status&&-1!==tabs[i].url.indexOf("loading.html")){var cachedUrl=getParameterByName("ckurl",tabs[i].url),settingsUrl=chrome.extension.getURL("ckSettings.html");settingsUrl+="?mode=1";var loadUrl=isAirGapWithFailUrl()?config.failUrl:settingsUrl;if(defined(cachedUrl)&&""!==cachedUrl.trim()){var queryIndex=loadUrl.indexOf("?");loadUrl=-1!==queryIndex&&queryIndex!==loadUrl.length-1?loadUrl+"&":loadUrl+"?"}loadUrl+="ckurl="+encodeURIComponent(cachedUrl),updateTab(tabs[i].id,loadUrl)}}))}function reloadAllUrlsDelay(){-1===reloadTimeout&&health.server.classificationReady&&(reloadTimeout=setTimeout(()=>{reloadCachedUrlForActiveTab(),reloadTimeout=-1},1e3))}function setAndEnableProxy(){proxyActive=!0,userState.proxyActive=!0,enableProxy(!1)}var modelInitialized=!1,serialInitialized=!1,startInitializing=!0;function registerEnterprise(){chrome.enterprise?(chrome.enterprise.hardwarePlatform&&chrome.enterprise.hardwarePlatform.getHardwarePlatformInfo((function(info){if(info&&defined(info.model)){var data={model:model=info.model};defined(info.manufacturer)&&(data.manufacturer=info.manufacturer),sendMessageToPopup(data)}setTimeout(()=>{modelInitialized=!0,start()},1e3)})),chrome.enterprise.deviceAttributes&&chrome.enterprise.deviceAttributes.getDeviceSerialNumber((function(sn){defined(sn)&&sendMessageToPopup({serialNumber:serialNumber=sn}),setTimeout(()=>{serialInitialized=!0,start()},1e3)}))):(serialInitialized=!0,modelInitialized=!0,start())}function testForDeviceSupport(callback){var emailTokens=email.split("@");if(emailTokens.length>1){var domain=emailTokens[1];isDeviceSupported(domain,serialNumber,model,callback)}}function start(){"chromeOS"==devicePlatform&&""!==email.trim()&&modelInitialized&&serialInitialized&&startInitializing&&versionInitialized&&!deviceSupportTested&&(startInitializing=!1,deviceSupportTested=!0,testForDeviceSupport(()=>{cacheInstallMode(),isInstalledOperationShuntMode()?disableProxy():isInstalledOperationAirgapMode()||(resetRetryCount(),cacheInstallDnsFailed(),retryCountExceeded()&&(newInstallation=!1,deviceSupported=!1,localStorage.setItem("installed",!0)),addInstallFailUrlToBypassList(),setStartupState(),sendStartupStateToPopup(),setModelCheckValue(),sendModelCheckToPopup(),isExtensionSupported()||newInstallation||dnsFailed()?(newInstallation&&(LOG("in start(). startApplication"),setInstallProxyMode(),isExtensionSupported()&&delayStartOnPremCheck()),startApplication(),setupProxyAndEnvironment()):(setToShuntMode(),localStorage.setItem("installed",!0))),getProxyConfig(),setCaptivePortalEnabledWhenErrorOrInstalling()}))}function setupProxyAndEnvironment(){initializePlatformDependencies(),sendHealthToPopup(),initializeProxy(),sendHealthToPopup()}function isInstalled(){var installed=localStorage.installed;try{newInstallation=!defined(installed)}catch(e){newInstallation=!1}}function getDeviceSupportedFromCache(){var supported=localStorage.supported;try{if(!(deviceSupported=!!(defined(supported)&&!0===JSON.parse(supported)||newInstallation))){var onFailMethodCache=localStorage.onFailMethod;defined(onFailMethodCache)&&(deviceSupported=!0,localStorage.supported=!0)}}catch(e){deviceSupported=!1}}function isShuntInstallFilterMode(){var _installFilterMode=getInstallFilterMode();return newInstallation&&_installFilterMode&&"shunt"===_installFilterMode.toLowerCase()}function reloadFailSettingsFromCache(){config.failUrl=defined(localStorage.failUrl)?localStorage.failUrl:"",config.onFailMethod=defined(localStorage.onFailMethod)?localStorage.onFailMethod:"",LOG("reloadFailSettingsFromCache fail url",config.failUrl,"fail method",config.onFailMethod),""!=config.failUrl&&config.failUrl.indexOf("os=1&domain=")!==config.failUrl.lastIndexOf("os=1&domain=")&&(config.failUrl="",localStorage.setItem("failUrl",""))}function saveToCache(key,value){localStorage[key]=value}function setStartupState(){startup.mode=getInstallFilterMode(),verifyPass()?(startup.status=health.server.classificationReady?"Filtering":"Initializing",retryCountExceeded()&&!deviceSupported&&(startup.status="Shunt")):startup.status=capitalizeFirstLetter(startup.mode)}function getStartupMessage(){return capitalizeFirstLetter(startup.mode)+": "+startup.status}function sendStartupStateToPopup(){sendMessageToPopup({startup:getStartupMessage()})}function setRunningMode(serverResponse){var currentRunningMode=runningMode.mode;runningMode.mode=defined(serverResponse.runningMode)?serverResponse.runningMode:"",console.log("current running mode",currentRunningMode,"new running mode",runningMode.mode),defined(serverResponse.runningMode)&&currentRunningMode!==serverResponse.runningMode&&("gateway"===serverResponse.runningMode.toLowerCase()?(health.online=!0,state.network.offline=!1):startCaptivePortalCheck()),sendMessageToPopup({mode:runningMode.mode})}function setDeviceSupported(){deviceSupported=!0,localStorage.supported=!0,LOG("setDeviceSupported")}function capitalizeFirstLetter(text){return text.charAt(0).toUpperCase()+text.slice(1)}function setModelCheckValue(){modelCheck=getInstallModelTest()}function sendModelCheckToPopup(){sendMessageToPopup({modelCheck:modelCheck})}function isExtensionSupported(){return deviceSupported}function disableProxyActiveToggle(){sendMessageToPopup({disabled:!0})}function isProxyDirect(){return"direct"===currentProxyMode}function setToShuntMode(){LOG("setToShuntMode. disabling proxy"),deviceSupported=!1,localStorage.setItem("supported",deviceSupported),disableProxy(),config.onFailMethod="shunt",disableProxyActiveToggle(),LOG("setToShuntMode. disabling proxy")}function isProxyModeDisabled(){return proxyModeServerSetting&&"disabled"===proxyModeServerSetting.toLowerCase()}function isProxyModeEnabled(){return proxyModeServerSetting&&"enabled"===proxyModeServerSetting.toLowerCase()}function isProxyModeUser(){return proxyModeServerSetting&&"user"===proxyModeServerSetting.toLowerCase()}function showSpinnerForTabUpdate(tab){var effectiveUrl=getEffectiveUrl(tab);defined(effectiveUrl)&&!urlsEqual(effectiveUrl,captivePortalUrl)&&(isInByPassList(effectiveUrl)||showLoadingPage(tab),LOG("showSpinnerForTabUpdate about to start application"),startApplication())}function urlsEqual(urlA,urlB){if(defined(urlA)&&""===urlA.trim()&&defined(urlB)&&""===urlB.trim())return!0;if(defined(urlA)&&""===urlA.trim()||defined(urlB)&&""===urlB.trim())return!1;if(!defined(urlA)&&defined(urlB)||defined(urlA)&&!defined(urlB))return!1;if(urlA===urlB)return!0;if(!isWebRequest(urlA)||!isWebRequest(urlB))return!1;var newA=urlA.replace(/\/$/,""),newB=urlB.replace(/\/$/,""),_urlA=new URL(newA),_urlB=new URL(newB);return _urlA.hostname.replace("www.","")==_urlB.hostname.replace("www.","")&&_urlA.pathname==_urlB.pathname}function onUpdatedTabNewInstallation(tab){isReservedUrl(getEffectiveUrl(tab))||(LOG("get install mode",getInstallFilterMode()),"shunt"===getInstallFilterMode()||applicationStarted&&health.server.classificationReady||startApplicationFailed?"shunt"===getInstallFilterMode()&&startDeviceNotSupportedTimer(tab):retryCountExceeded()||(inGatewayMode()?startDeviceNotSupportedTimer(tab):showSpinnerForTabUpdate(tab)))}function onUpdatedTabExistingInstallation(tab){if(isShunt())applicationStarted&&readyToShowFailUrl()&&!newInstallation&&(shuntErrorAlertSent||(sendErrorAlertToServer(),shuntErrorAlertSent=!0)),!health.server.classificationReady&&health.server.error&&startApplication();else{if(LOG("onUpdatedTabExistingInstallation",tab),defined(tab.pendingUrl)&&isReservedUrl(tab.pendingUrl)||!defined(tab.url)&&isReservedUrl(tab.url))return;if(LOG("onUpdatedTabExistingInstallation class ready",health.server.classificationReady,"error",health.server.error,"health online",health.online,"nav online",navigator.onLine),applicationStarted){if(isApplicationAirgap()&&!health.server.classificationReady&&health.server.error){var effectiveUrl=getEffectiveUrl(tab);if(defined(effectiveUrl)&&isAirGapWithFailUrl()&&readyToShowFailUrl()&&!isInByPassList(effectiveUrl)){LOG("onUpdatedTabExistingInstallation effective url",effectiveUrl);var failUrl=config.failUrl,queryIndex=failUrl.indexOf("?");failUrl=-1!==queryIndex&&queryIndex!==failUrl.length-1?failUrl+"&":failUrl+"?",failUrl+="ckurl="+encodeURIComponent(effectiveUrl),updateTab(tab.id,failUrl)}else showSpinnerForTabUpdate(tab)}}else showSpinnerForTabUpdate(tab)}}var reloadUrlActiveTabTimer=-1;function removeNullsFromArray(list){for(var i=0;i<list.length;i++)defined(list[i])||(list.splice(i,1),i--)}function shouldRestartApplication(){return!newInstallation&&deviceSupported}function setApplicationProxyMode(){!newInstallation&&deviceSupported&&isApplicationAirgap()&&!isNetworkOffline()?(LOG("setApplicationProxyMode"),enableProxy(!0)):(disableProxy(),LOG("setApplicationProxyMode. disabling proxy"))}function isInstalledOperationAirgapMode(){return"airgap"===getInstallOperationFilterMode().toLowerCase()}function showInstallAirgapLoadingPage(tab){var initializationUrl=getLoadingUrl(tab);LOG("showInstallAirgapLoadingPage"),updateTab(tab.id,initializationUrl,tab.url)}function isApplicationAirgap(){return defined(config.onFailMethod)&&"airgap"==config.onFailMethod.toLowerCase()}function proxyEnabled(){return"pac_script"==currentProxyMode}function reloadBypassListOnStartUp(callback){if(!newInstallation){var cachedByPass=localStorage.bypass;defined(cachedByPass)&&(serverByPassList=JSON.parse(cachedByPass));var addedServerByPassList=getCombinedServerAndDefaultByPassList(),newByPassList=JSON.parse(addedServerByPassList),bypassListAdded=proxyDataScript.replace("{defaultBypassList}",addedServerByPassList,"g"),stringifiedAlwaysProxyList=JSON.stringify(defaultAlwaysProxyList);bypassListAdded=bypassListAdded.replace("{alwaysProxyList}",stringifiedAlwaysProxyList,"g"),proxyDefaultConfig.pacScript.data=bypassListAdded,currentBypassList=newByPassList,currentAlwaysProxyList=defaultAlwaysProxyList,isShunt()||(LOG("current by passlist ",currentBypassList),setProxyConfig(proxyDefaultConfig,newByPassList,()=>{callback&&callback()}))}}function processTabUpdate(tab){if(LOG("processTabUpdate",tab.url,"mode",currentProxyMode,"online",health.online,"nav online",navigator.onLine),navigator.onLine&&!isInstalledOperationShuntMode()&&userState.proxyActive&&(resetNonActivityTimer(),(navigator.onLine&&!state.captivePortal.active||(LOG("captive portal tab",tab),!processCaptivePortalTab(tab)))&&(isWebRequest(tab.pendingUrl)||isWebRequest(tab.url))))if(LOG("not tab portal update",tab.url),isInstalledOperationAirgapMode())showInstallAirgapLoadingPage(tab);else{if(isInstalledOperationShuntMode())return;"loading"!=tab.status&&"complete"!=tab.status||!deviceSupported&&!newInstallation||(LOG("Device supported"),newInstallation?onUpdatedTabNewInstallation(tab):onUpdatedTabExistingInstallation(tab))}}function startReadyErrorMessageTimer(){-1==state.error.readyToShowErrorMessageTimeout&&(state.error.readyToShowErrorMessageTimeout=setTimeout(()=>{state.error.readyToShowErrorMessage=!0,state.error.readyToShowErrorMessageTimeout=-1},state.error.readyToShowErrorMessageTimeoutValue))}function readyToShowFailUrl(){return state.classification.failCount>=state.classification.failCountBeforeFailUrl}function parseScreenState(serverResponse){defined(serverResponse.screenState)&&""!==serverResponse.screenState&&"screenOff"===serverResponse.screenState&&acknowledgeScreenOff()}function retryAcknowledgeScreenOff(){clearTimeout(acknowledgeTimeout),acknowledgeTimeout=setTimeout(()=>{getProxyInProgress=!1,acknowledgeScreenOff()},acknowledgeRetryTime)}function acknowledgeScreenOff(){var proxyServerUrl=getProxyServerUrl();""!==proxyServerUrl&&ajaxCall(proxyServerUrl+"/ckAcknowledgeScreen",(function(successXhr){successXhr.responseText&&successXhr.responseText.length>0&&restartReadyToShowErrorMessage()}),(function(failXhr){retryAcknowledgeScreenOff()}),(function(){retryAcknowledgeScreenOff()}))}function restartReadyToShowErrorMessage(){state.error.readyToShowErrorMessage=!1,startReadyErrorMessageTimer()}function retryProxyPacFile(){lastDomainByPassUpdateTime=-1,clearTimeout(getProxyTimeout),getProxyTimeout=setTimeout(()=>{getProxyInProgress=!1,getProxyPacFile()},proxyRetryTime)}function getDefaultValue(value,defaultValue){return defined(value)&&""!==value?value:defined(defaultValue)&&""!==defaultValue?defaultValue:""}function updateNetworkOffline(){0===navigator.connection.rtt&&(state.network.offline=!0,disableProxy(),LOG("updateNetworkOffline. disabling proxy"))}function isNetworkOffline(){return state.network.offline}function platformInitialized(){updateNetworkOffline(),initializeProxyActive(),reloadBypassListOnStartUpAndReload(),getDeviceSupportedFromCache(),reloadFailSettingsFromCache(),setApplicationProxyMode(),registerEnterprise(),getProfileUserInfo()}function enableProxyWithBypassList(cacheImmediately){if(userState.proxyActive){proxyActive=!0;var addedServerByPassList=getCombinedServerAndDefaultByPassList(),updatedBypassList=JSON.parse(addedServerByPassList);cacheImmediately&&(currentBypassList=updatedBypassList);var updatedProxyData=proxyDataScript.replace("{defaultBypassList}",addedServerByPassList,"g"),stringifiedAlwaysProxyList=JSON.stringify(defaultAlwaysProxyList);updatedProxyData=updatedProxyData.replace("{alwaysProxyList}",stringifiedAlwaysProxyList,"g"),proxyDefaultConfig.pacScript.data=updatedProxyData,currentAlwaysProxyList=defaultAlwaysProxyList,isShunt()||setProxyConfig(proxyDefaultConfig,updatedBypassList)}}chrome.webNavigation.onBeforeNavigate.addListener((function(details){0===details.frameId&&chrome.tabs.get(details.tabId,(function(tab){!defined(chrome.runtime.lastError)&&defined(tab)&&processTabUpdate(tab)}))}));var delayClassTimeout=-1;function updateFailCount(){health.server.error&&health.online&&navigator.onLine?state.classification.failCount++:(state.classification.failCount=0,shuntErrorAlertSent=!1)}function isReservedUrl(url){if(!defined(url))return!1;var installFailUrl=getInstallFailUrl(),loadingUrl=chrome.extension.getURL("loading.html");return!!(urlsEqual(url,config.failUrl)||urlsEqual(url,captivePortalUrl)||-1!==url.indexOf("ceprof.contentkeeper.net")||urlsEqual(url,installFailUrl)||-1!==url.indexOf(loadingUrl))}function reloadCachedUrlForActiveTab(force=!1){"pac_script"!==currentProxyMode&&userState.proxyActive&&!force||chrome.tabs.query({active:!0,currentWindow:!0},(function(tabs){if(tabs.length>0){var outerTabUrl=tabs[0].url,loadingUrl=chrome.extension.getURL("loading.html"),applicationFailUrl=config.failUrl;LOG("reloadCachedUrlForActiveTab outer tab url",outerTabUrl,"tabs status",tabs[0].status);var settingsUrl=chrome.extension.getURL("ckSettings.html");if(-1!==outerTabUrl.indexOf(loadingUrl)||urlsEqual(outerTabUrl,applicationFailUrl)||!newInstallation&&-1!==outerTabUrl.indexOf(settingsUrl)){var cachedUrl=getParameterByName("ckurl",outerTabUrl);defined(cachedUrl)&&""!==cachedUrl.trim()&&chrome.tabs.discard(tabs[0].id,(function(){chrome.tabs.query({index:tabs[0].index,currentWindow:!0},(function(tabsInner){1===tabsInner.length?chrome.tabs.update(tabsInner[0].id,{url:cachedUrl},(function(updatedTab){chrome.runtime.lastError?LOG("can't update tab",chrome.runtime.lastError.message):(LOG("reloadCachedUrlForActiveTab updated tab id",updatedTab.id,"cached url",cachedUrl),updateCaptivePortalTabId(updatedTab.id,tabs[0].id))})):LOG("reloadCachedUrlForActiveTab no inner tabs found")}))}))}}}))}function isCaptivePortalTab(tab){return LOG("is captive porta",defined(cachedCaptivePortalRequests[tab.id])),LOG("cached captive portals",cachedCaptivePortalRequests),defined(cachedCaptivePortalRequests[tab.id])}function isInternetDisconnectedTab(tab){return defined(interenetDisconnectedUrls[tab.id])}function insertInternetDisconnectedTab(tab){interenetDisconnectedUrls[tab.id]=tab,LOG("caching tab disconnected",tab)}function clearInternetDisconnectedTab(tab){defined(interenetDisconnectedUrls[tab.id])&&delete interenetDisconnectedUrls[tab.id]}function cacheInstallDnsFailed(){isInstallDnsFailed()?localStorage.setItem("dnsFailed",!0):localStorage.removeItem("dnsFailed")}function dnsFailed(){var dnsFailedCache=localStorage.getItem("dnsFailed");return!!defined(dnsFailedCache)&&!0===JSON.parse(dnsFailedCache)}function cacheRetryAttempts(){newInstallation&&(retryAttempts++,localStorage.retryAttempts=retryAttempts)}function loadNumberOfRetryAttemptsFromCache(){var attempts=localStorage.retryAttempts;defined(attempts)&&(retryAttempts=parseInt(attempts,10),isNaN(retryAttempts)&&(retryAttempts=0),LOG("retry attempts",retryAttempts))}function retryCountExceeded(){return-1!==retryCount&&((0!==retryCount||0!==retryAttempts)&&retryAttempts>retryCount)}function showInstallFailUrl(tab){var url=""!==getInstallFailUrl()?getInstallFailUrl():getLoadingUrl(tab);LOG("showInstallFailUrl",url),urlsEqual(tab.url,url)||chrome.tabs.update(tab.id,{url:url},(function(updatedTab){}))}function addInstallFailUrlToBypassList(){var installFailUrl=getInstallFailUrl();if(defined(installFailUrl)&&""!==installFailUrl.trim()&&newInstallation){LOG("intall fail url",installFailUrl);var combinedInstallFailUrlList=combineListUnique([new URL(installFailUrl).hostname],installBypassList),stringified=JSON.stringify(combinedInstallFailUrlList),bypassListAdded=proxyDataScript.replace("{defaultBypassList}",stringified,"g"),stringifiedAlwaysProxyList=JSON.stringify(defaultAlwaysProxyList);return bypassListAdded=bypassListAdded.replace("{alwaysProxyList}",stringifiedAlwaysProxyList,"g"),proxyDefaultConfig.pacScript.data=bypassListAdded,currentBypassList=combinedInstallFailUrlList,currentAlwaysProxyList=defaultAlwaysProxyList,combinedInstallFailUrlList}return null}function isAirgapInstallMode(){return"airgap"===getInstallFilterMode().toLowerCase()}function resetRetryCount(){var retryCountExceededState=retryCountExceeded();if(retryCount=getInstallRetryCount(),!retryCountExceededState||-1!==retryCount){var retryCountCached=localStorage.getItem("retryCount");if(defined(retryCountCached)){var retryCountCachedInt=parseInt(retryCountCached,10);isNaN(retryCountCachedInt)||retryCount===retryCountCachedInt||(localStorage.setItem("retryCount",retryCount),localStorage.setItem("retryAttempts",0),retryAttempts=0,deviceSupported||(newInstallation=!0,localStorage.removeItem("installed"),localStorage.removeItem("supported"),deviceSupported=!0))}else-1!==retryCount&&localStorage.setItem("retryCount",retryCount)}}function reloadBypassListOnStartUpAndReload(){reloadBypassListOnStartUp(()=>{applicationStarted||setTimeout(()=>{reloadCachedUrlForActiveTab()},500)})}function getEffectiveUrl(tab){return isWebRequest(tab.pendingUrl)?tab.pendingUrl:isWebRequest(tab.url)?tab.url:null}function updateCaptivePortalTabId(newId,oldId){var cachedTab=cachedCaptivePortalRequests[oldId];defined(cachedTab)&&(cachedTab.tab.id=newId)}function reloadCaptivePortalUrls(){for(var cachedTabId in cachedCaptivePortalRequests){var cachedTab=cachedCaptivePortalRequests[cachedTabId],tabId=cachedTab.tab.id;chrome.tabs.get(tabId,(function(getTab){(!defined(chrome.runtime.lastError)||defined(chrome.runtime.lastError)&&"string"!=typeof chrome.runtime.lastError.message)&&(LOG("reloadCaptivePortalUrls"),chrome.tabs.update(tabId,{url:cachedTab.url},(function(updatedTab){LOG("captive reload previous tab id",tabId,"new tab id",updatedTab.id)})))}))}}function clearCaptivePortalCache(){cachedCaptivePortalRequests={}}function setInstallProxyMode(){"shunt"===getInstallFilterMode()&&(LOG("setInstallProxyMode. set to shunt disabling proxy"),disableProxy())}function isInstalledOperationShuntMode(){return"shunt"===getInstallOperationFilterMode().toLowerCase()}function setDeviceNotSupportedForWindow(){(newInstallation||isShunt())&&(deviceSupported=!1,startApplicationFailed=!0,newInstallation&&retryCountExceeded()&&(localStorage.supported=!1),LOG("setDeviceNotSupportedForWindow disabling proxy"),disableProxy(),reloadCachedUrlForActiveTab(!0),stopOnPremCheck(),stopCaptivePortalCheck(),setCaptivePortalEnabled(!1))}function combineListUnique(listA,listB){var appendedList=listA.concat(listB),proxySet=new Set(appendedList),uniqueProxyList=Array.from(proxySet);return JSON.stringify(uniqueProxyList)}function cacheInstallMode(){var installFilterMode=getInstallFilterMode();localStorage.setItem("installMode",installFilterMode)}function loadInstallModeFromCache(){var installFilterMode=localStorage.getItem("installMode");defined(installFilterMode)&&setInstallFilterMode(installFilterMode)}function initialize(){startNonActivityTimer(),subscribeCaptivePortal(),subscribeLocationAwareness(),isInstalled(),loadProxyModeFromCache(),getVersion(),loadRetryCountFromCache(),loadNumberOfRetryAttemptsFromCache(),loadInstallModeFromCache(),reloadBypassListOnStartUp()}function startDeviceNotSupportedTimer(tab){(LOG("startDeviceNotSupportedTimer. timer",notSupportedTimer),-1===notSupportedTimer)&&(notSupportedTimer=setTimeout((function(){processDeviceNotSupported(tab)}),newInstallation?newInstallAppStartTime+deviceNotSupportedOffsetTime:appInstalledStartTime+deviceNotSupportedOffsetTime))}function updateTabWithSettingsPage(displayUrl,tab){chrome.tabs.query({},(function(tabs){for(var loadingUrl=chrome.extension.getURL("loading.html"),i=0;i<tabs.length;i++)if("complete"===tabs[i].status&&(-1!==tabs[i].url.indexOf(loadingUrl)||newInstallation))if(newInstallation&&isShuntInstallFilterMode())tabs[i].id===tab.id&&updateTab(tabs[i].id,displayUrl);else{var cachedUrl=getParameterByName("ckurl",tabs[i].url);defined(cachedUrl)&&""!==cachedUrl.trim()&&(displayUrl+="&ckurl="+encodeURIComponent(cachedUrl),updateTab(tabs[i].id,displayUrl))}}))}function loadRetryCountFromCache(){var retryCountCached=localStorage.getItem("retryCount");defined(retryCountCached)&&(retryCountCached=parseInt(retryCountCached,10),isNaN(retryCountCached)||(retryCount=retryCountCached))}function watchdogError(){health.server.started=!1,health.server.classificationReady=!1,applicationStarted=!1,proxyServerRunning=!1,health.server.error=!0,sendHealthToPopup(!1),isShunt()&&(LOG("watchdog error. disabling proxy"),disableProxy()),setCaptivePortalEnabled(!0)}function addUserDataToApplicationFailUrl(){if(config.failUrl&&""!==config.failUrl&&-1===config.failUrl.indexOf("os=1&domain=")){addDefaultQueryParamsToApplicationFailUrl();var base64Data=getFailUrlBase64Data();config.failUrl+="&data=",config.failUrl+=base64Data}}function addDefaultQueryParamsToApplicationFailUrl(){if(config.failUrl&&""!==config.failUrl&&-1===config.failUrl.indexOf("os=1&domain=")){var queryParams="os=1&domain="+domain;urlHasQueryParams(config.failUrl)?(config.failUrl.endsWith("?")||(config.failUrl+="&"),config.failUrl+=queryParams):(config.failUrl+="?",config.failUrl+=queryParams)}}function getLoadingUrl(tab){var loadingUrl=chrome.extension.getURL("loading.html"),effectiveUrl=getEffectiveUrl(tab);return defined(effectiveUrl)&&(loadingUrl+="?ckurl="+encodeURIComponent(effectiveUrl)),loadingUrl}function reloadActiveTabWhenProxyActive(details){("pac_script"===currentProxyMode||!userState.proxyActive||inGatewayMode()&&newInstallation||!isExtensionSupported()&&newInstallation)&&chrome.tabs.get(details.tabId,(function(tab){if(!defined(chrome.runtime.lastError)){var loadingUrl=chrome.extension.getURL("loading.html");LOG("tab focussed. loading url",loadingUrl,"tab url",tab.url,"index",tab.url.indexOf(loadingUrl));var settingsUrl=chrome.extension.getURL("ckSettings.html");if("chrome://extensions/"===tab.url||-1===tab.url.indexOf(loadingUrl)&&(newInstallation||1===tab.url.indexOf(settingsUrl)))LOG("not updating tab with cached url");else{var cachedUrl=getParameterByName("ckurl",tab.url);defined(cachedUrl)&&""!==cachedUrl.trim()&&updateTab(details.tabId,cachedUrl)}}}))}function loadProxyModeFromCache(){LOG("loadProxyModeFromCache. new installation",newInstallation),newInstallation||(reloadFailSettingsFromCache(),"shunt"===config.onFailMethod&&(LOG("loadProxyModeFromCache. onFailMethod is shunt. disabling proxy"),disableProxy()))}function sendErrorAlertToServer(){state.alertSent||(fetch(config.failUrl).then((function(response){200===response.status?LOG("Successfull sent error alert"):LOG("Failed to send error alert. Status",response.status,"Response text",response.statusText)})).catch((function(error){LOG("Error alert exception",error)})),state.alertSent=!0)}function sendSerial(){if(serialInitialized){var proxyServerUrl=getProxyServerUrl();if(""!==proxyServerUrl&&""!==health.user.profile.email)fetch(proxyServerUrl+"/ckSerial?sid="+serialNumber).then((function(response){200===response.status?LOG("Sucessfully sent  serial"):LOG("Failed to send serial. Status",response.status,"Response text",response.statusText)})).catch((function(error){LOG("Error serial exception",error)}))}}function parseSendSerial(serverResponse){!!serverResponse.sendSerial&&sendSerial()}function subscribeCaptivePortal(){captivePortalPublishSubscribe&&captivePortalPublishSubscribe.subscribe&&captivePortalPublishSubscribe.subscribe(captivePortalSubscriptionName,updateIsOffline)}function startNonActivityTimer(){nonActivityTimer=setTimeout(()=>{stopCaptivePortalCheck()},nonActivityPeriodMilliSeconds)}function resetNonActivityTimer(){clearTimeout(nonActivityTimer),deviceSupported?(startNonActivityTimer(),startCaptivePortalCheck()):stopCaptivePortalCheck()}function applicationTxtInitialised(){stopCaptivePortalCheck(),getCaptivePortalsFromServer(),addCaptivePortalToByPass(),startCaptivePortalCheck(!0),applicationTxtInProgress=!1,updateCaptivePortalConfig()}function fetchCaptiveTxtIfFailed(){defined(captivePortalConfiguration)||!defined(domain)||applicationTxtInProgress||-1===captivePortalConfiguration||(applicationTxtInProgress=!0,callgetApplicationTxtRetry(domain,applicationTxtInitialised,applicationTxtFailed,0,3))}function applicationTxtFailed(){stopCaptivePortalCheck(),getCaptivePortalsFromServer(),addCaptivePortalToByPass(),startCaptivePortalCheck(!0),applicationTxtInProgress=!1}function clearDeviceTimeouts(){-1!==initializingTimeout&&(clearTimeout(initializingTimeout),initializingTimeout=-1),-1!==initializingTimeoutSecond&&(clearTimeout(initializingTimeoutSecond),initializingTimeoutSecond=-1),-1!==notSupportedTimer&&(clearTimeout(notSupportedTimer),notSupportedTimer=-1)}function processCaptivePortalTab(tab){if(!isWebRequest(tab.pendingUrl)&&!isWebRequest(tab.url))return!1;if(isInstalledOperationAirgapMode())return!1;if(isApplicationAirgap()||newInstallation){var effectiveUrl=getEffectiveUrl(tab);return!(!defined(effectiveUrl)||!isInByPassList(effectiveUrl))||delayReloadCaptivePortalUrl(tab)}return!1}function delayReloadCaptivePortalUrl(tab){var effectiveUrl=getEffectiveUrl(tab);if(null!=effectiveUrl&&!isReservedUrl(effectiveUrl)){var cachedTab=null;for(var tempTabId in cachedCaptivePortalRequests){var tabIdInt=parseInt(tempTabId,10);if(urlsEqual(cachedCaptivePortalRequests[tempTabId].url,effectiveUrl)||tabIdInt==tab.id){cachedTab=cachedCaptivePortalRequests[tempTabId];break}}var loadingUrl=isReservedUrl(effectiveUrl);if(loadingUrl&&defined(cachedTab)&&(effectiveUrl=cachedTab.url),LOG("cached captive portal",cachedCaptivePortalRequests,"captive reloaded ",captivePortalReloaded),defined(cachedTab)&&!loadingUrl||captivePortalReloaded)return!0;cachedCaptivePortalRequests[tab.id]={timeout:-1,url:effectiveUrl,tab:tab},setCaptivePortalReloadTimeout(tab,effectiveUrl)}return!1}function setCaptivePortalReloadTimeout(tab,effectiveUrl){var cachedTab=cachedCaptivePortalRequests[tab.id];cachedTab.timeout=setTimeout(()=>{var tabId=cachedTab.tab.id;captivePortalReloaded=!0,chrome.tabs.get(tabId,(function(getTab){LOG("tab id ",tabId,"cachedTab",cachedTab),(!defined(chrome.runtime.lastError)||defined(chrome.runtime.lastError)&&"string"!=typeof chrome.runtime.lastError.message)&&(LOG("reloading captive portal ",effectiveUrl,"current proxy config",currentProxyMode),chrome.tabs.update(tabId,{url:effectiveUrl},(function(updatedTab){chrome.runtime.lastError&&LOG("setCaptivePortalReloadTimeout",chrome.runtime.lastError.message),LOG("captive reload previous tab id",tabId,"new tab id",updatedTab.id)})))}))},1e4)}function subscribeLocationAwareness(){locationAwarenessPublishSubscribe&&locationAwarenessPublishSubscribe.subscribe&&locationAwarenessPublishSubscribe.subscribe(locationAwarenessSubscriptionName,locationAwarenessUpdates)}function locationAwarenessUpdates(data){if(defined(data)&&newInstallation)if(!0===data.onprem)state.onprem.enabled=!0,state.onprem.forceShuntMode=!!isAirgapInstallMode(),state.onprem.forceShuntMode&&(LOG("On-prem true. Forcing shunt mode"),disableProxy()),runningMode.mode="Gateway",sendMessageToPopup(data={mode:runningMode.mode}),reloadCachedUrlForActiveTab(!0);else if(!1===data.onprem){state.onprem.enabled=!1,state.onprem.forceShuntMode=!1,proxyActive=!0,enableProxy(),runningMode.mode="",sendMessageToPopup(data={mode:runningMode.mode})}}function clearOnPremCheck(){stopOnPremCheck(),state.onprem.enabled=!1,state.onprem.forceShuntMode=!1}function updateCaptivePortalConfig(){if(defined(captivePortalConfiguration)&&-1!==captivePortalConfiguration&&defined(captivePortalConfiguration.inactivitySeconds)){var inactivitySeconds=parseInt(captivePortalConfiguration.inactivitySeconds),inactivityMillieSeconds=isNaN(inactivitySeconds)?DEFAULT_CAPTIVE_PORTAL_INACTIVITY_MILLISECONDS:1e3*inactivitySeconds;clearTimeout(nonActivityTimer),nonActivityPeriodMilliSeconds=inactivityMillieSeconds>DEFAULT_CAPTIVE_PORTAL_INACTIVITY_MILLISECONDS||inactivityMillieSeconds<DEFAULT_CAPTIVE_PORTAL_INACTIVITY_MILLISECONDS?DEFAULT_CAPTIVE_PORTAL_INACTIVITY_MILLISECONDS:inactivityMillieSeconds,startNonActivityTimer()}}function inGatewayMode(){return"gateway"===runningMode.mode.toLowerCase()}function getInstallFailMessage(){var message=`Device not supported. Failed to start application. Attempted ${retryAttempts} times.`;return retryCountExceeded()&&(message+=" Exceeded the number of allowed attempts. Device is not supported"),message}function processDeviceNotSupported(tab){if(shouldShowSettingsPage()){if(!defined(tab))return;var installFailUrl=getInstallFailUrl(),displayUrl=chrome.extension.getURL("ckSettings.html"),mode="?mode=1";if(newInstallation&&(mode="?mode=2",defined(installFailUrl)&&""!==installFailUrl)){var message=getInstallFailMessage(),installBas64Data=getInstallFailUrlBase64Data(message),dataQueryParam=-1!==installFailUrl.indexOf("?")?"&data=":"?data=";displayUrl=`${installFailUrl}${dataQueryParam}${installBas64Data}`,mode=""}updateTabWithSettingsPage(displayUrl+=mode,tab)}setDeviceNotSupportedForWindow()}function shouldShowSettingsPage(){return!(isShunt()||isShuntInstallFilterMode()||inGatewayMode()&&newInstallation)}function getFailUrlBase64Data(){var data={os:devicePlatform,message:"Application failed to classify request. Classification service not responding",chromeOS:{extension:{email:email,serialId:serialNumber,deviceModel:model,version:extension.version,id:extension.id},service:{version:applicationVersion}}},dataString=JSON.stringify(data);return btoa(dataString)}function getProxyConfig(){chrome.proxy.settings.get({},(function(config){console.log("proxy config "+JSON.stringify(config)),(proxyConfigured=!(!config||"controlled_by_this_extension"!==config.levelOfControl))||(toggleDisabled=!0,proxyActive=!1),sendMessageToPopup({proxyState:proxyActive,disabled:toggleDisabled,proxyConfigured:proxyConfigured})}))}function parseLastNetworkChangeTime(serverResponse){defined(serverResponse.lastNetworkChangeTime)&&state.network.lastNetworkChangeTime!==serverResponse.lastNetworkChangeTime&&(LOG("Network update time has changed"),inGatewayMode()||(state.network.lastNetworkChangeTime=serverResponse.lastNetworkChangeTime,stopCaptivePortalCheck(),setCaptivePortalEnabled(!0),startCaptivePortalCheck()))}function checkNavigatorOnlineInterval(){newInstallation||(rtt0CheckNavigatorOnlineInterval=setInterval(()=>{navigator.onLine&&(userState.proxyActive&&enableProxy(!1,!0),clearInterval(rtt0CheckNavigatorOnlineInterval),rtt0CheckNavigatorOnlineInterval=-1)},100))}function setCaptivePortalEnabledWhenErrorOrInstalling(){newInstallation||health.server.started&&health.server.error?setCaptivePortalEnabled(!0):setCaptivePortalEnabled(!1)}function addCaptivePortalToByPass(){var captivePortals=getCaptivePortals();for(let i=0;i<captivePortals.length;i++){var wildCardUrl=getWildCardDomainFromUrl(captivePortals[i].url);wildCardUrl&&addCaptivePortalUrlToByPassList(wildCardUrl)}}function addCaptivePortalUrlToByPassList(url){var defaultIndex=defaultBypassList.indexOf(url),installIndex=installBypassList.indexOf(url),currentIndex=currentBypassList.indexOf(url);-1===defaultIndex&&defaultBypassList.unshift(url),-1===installIndex&&installBypassList.unshift(url),-1===currentIndex&&currentBypassList.unshift(url)}function getWildCardDomainFromUrl(url){if(!defined(url))return null;var hostname=getLocation(url).hostname;return"*"+(hostname=(hostname=(hostname=hostname.replace("www.","")).replace("http://","")).replace("https://",""))+"/*"}chrome.tabs.onActivated.addListener((function(details){(health.online||inGatewayMode())&&reloadActiveTabWhenProxyActive(details)})),initialize();
